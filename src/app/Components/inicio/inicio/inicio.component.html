<div class="imagenPrincipal">
  <div class="contenedorChat">

    <header class="topbar">
      <div class="topbar__left">
        <i class="fas fa-bars topbar__menu-movil"></i>
        <i class="fas fa-comments topbar__logo"></i>
        <span class="topbar__brand">TejeChat</span>
      </div>

      <div class="topbar__search">
        <i class="bi bi-search topbar__search-icon"></i>
        <input type="search" class="topbar__search-input" placeholder="Buscar o iniciar un chat" [value]="topbarQuery"
          (input)="onTopbarSearch($event)" (focus)="topbarOpen = !!topbarResults.length" />

        <div class="topbar__results collapse" [class.show]="topbarOpen" (mousedown)="$event.preventDefault()">
          <div *ngIf="topbarSearching" class="result-row muted">Buscando…</div>
          <div *ngIf="!topbarSearching && topbarResults.length === 0" class="result-row muted">Sin resultados</div>
          <button type="button" class="result-row" *ngFor="let u of topbarResults; trackBy: trackIndex"
            (click)="onTopbarResultClick(u)">
            <div class="result-avatar-wrap">
              <img [src]="avatarOrDefaultUser(u)" alt="" class="result-avatar" />
              <span class="estado-icono-topbar" [ngClass]="{
                  'conectado-topbar': u.estado === 'Conectado',
                  'desconectado-topbar': !u.estado || u.estado === 'Desconectado',
                  'ausente-topbar': u.estado === 'Ausente'
                }" [attr.title]="u.estado || 'Desconectado'">
                <i class="bi" [ngClass]="{
                    'bi-check': u.estado === 'Conectado',
                    'bi-x-circle-fill': !u.estado || u.estado === 'Desconectado',
                    'bi bi-stopwatch ausente-icono-topbar': u.estado === 'Ausente'
                  }"></i>
              </span>
            </div>
            <div class="full-name">{{ nombreCompleto(u) }}</div>
            <div class="email">{{ u.email }}</div>
          </button>
        </div>
      </div>

      <div class="topbar__right">
        <div #notifWrapper class="notif-wrapper" [class.open]="panelNotificacionesAbierto">
          <button class="topbar__btn notif-btn" title="Notificaciones" aria-label="Notificaciones"
            (click)="togglePanelNotificaciones()">
            <i class="fas fa-bell"></i>
            <span *ngIf="invitePendingCount > 0" class="notif-badge">
              {{ invitePendingCount <= 99 ? invitePendingCount : '99+' }} </span>
          </button>
          <div class="notif-panel" *ngIf="panelNotificacionesAbierto">
            <div class="notif-header">Notificaciones</div>
            <ng-container *ngIf="notifInvites.length else notifEmpty">
              <div *ngFor="let n of notifInvites" class="notif-card">
                <div class="notif-text">
                  <strong>{{ n.inviterNombre }}</strong> te invita al grupo <strong>“{{ n.groupName }}”</strong>
                </div>
                <div class="notif-actions">
                  <button class="btn-add-user" (click)="aceptarInvitacion(n)">Aceptar</button>
                  <button class="btn-opcion-eliminar" (click)="rechazarInvitacion(n)">Cancelar</button>
                </div>
              </div>
            </ng-container>
            <ng-template #notifEmpty>
              <div class="notif-empty">Sin notificaciones</div>
            </ng-template>
          </div>
        </div>
        <button class="topbar__btn" title="Ajustes"><i class="fas fa-cog"></i></button>
        <div class="topbar-profile-wrapper" (click)="$event.stopPropagation()">
          <button class="topbar__avatar-btn" type="button" (click)="toggleTopbarProfileMenu($event)">
            <img *ngIf="usuarioFotoUrl; else topbarAvatarFallback" [src]="usuarioFotoUrl" alt="Perfil" class="topbar__avatar" />
            <ng-template #topbarAvatarFallback>
              <span class="topbar__avatar-fallback">{{ usuarioIniciales }}</span>
            </ng-template>
          </button>
          <div class="topbar-profile-menu" *ngIf="showTopbarProfileMenu">
            <button type="button" class="topbar-profile-item" (click)="openProfileView($event)">
              <i class="bi bi-person-circle"></i>
              Ver mi perfil
            </button>
            <button type="button" class="topbar-profile-item" (click)="closeProfileView()">
              <i class="bi bi-chat-dots"></i>
              Volver a chats
            </button>
            <button type="button" class="topbar-profile-item topbar-profile-item--danger" (click)="logoutFromTopbar($event)">
              <i class="bi bi-box-arrow-right"></i>
              Cerrar sesión
            </button>
          </div>
        </div>
      </div>
    </header>
    <div class="toast-container position-fixed top-0 start-0 p-3" style="z-index: 1080;">
      <div
        *ngFor="let t of toasts"
        class="toast show align-items-center text-white border-0 mb-2"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
        [ngClass]="{
          'bg-danger': t.variant === 'danger',
          'bg-success': t.variant === 'success',
          'bg-warning text-dark': t.variant === 'warning',
          'bg-info': t.variant === 'info'
        }"
      >
        <div class="d-flex">
          <div class="toast-body">
            <strong *ngIf="t.title">{{ t.title }}:</strong> {{ t.message }}
          </div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            aria-label="Close"
            (click)="dismissToast(t.id)"
          ></button>
        </div>
      </div>
    </div>

    <div class="cuerpoChat" [class.modo-chat-movil]="chatSeleccionadoId !== null">

      <div class="barraLateral">
        <div class="iconos-superiores">
          <i class="fas fa-home icono-barra"></i>
          <i class="fas fa-comment icono-barra active"></i>
          <i class="fas fa-star icono-barra"></i>
        </div>
        <div class="usuario-config">
          <img *ngIf="usuarioFotoUrl; else sideAvatarFallback" [src]="usuarioFotoUrl" alt="Perfil" class="topbar__avatar" />
          <ng-template #sideAvatarFallback>
            <span class="topbar__avatar-fallback">{{ usuarioIniciales }}</span>
          </ng-template>
          <i class="fas fa-cog icono-barra"></i>
        </div>
      </div>

      <div class="listadoChats">
        <div class="encabezado-chats">
          <div class="titulo-chat">TejeChat</div>
          <div class="acciones-chat">
            <button class="icono-chat" title="Crear grupo" data-bs-toggle="modal" (click)="crearGrupoModal.open()"
              data-bs-target="#crearGrupoModal">
              <i class="fas fa-users"></i>
            </button>
            <i class="fas fa-ellipsis-v icono-chat" title="Opciones"></i>
          </div>
        </div>

        <div class="buscador">
          <input type="text" placeholder="Buscar personas..." class="input-busqueda" [value]="busquedaChat"
            (input)="onSearchChange($event)" />
        </div>
        <div class="chat-filters">
          <button
            type="button"
            class="chat-filter-btn"
            [class.is-active]="isChatListFilterActive('TODOS')"
            (click)="setChatListFilter('TODOS')">
            Todos
          </button>
          <button
            type="button"
            class="chat-filter-btn"
            [class.is-active]="isChatListFilterActive('LEIDOS')"
            (click)="setChatListFilter('LEIDOS')">
            Leidos
          </button>
          <button
            type="button"
            class="chat-filter-btn"
            [class.is-active]="isChatListFilterActive('NO_LEIDOS')"
            (click)="setChatListFilter('NO_LEIDOS')">
            No leidos
          </button>
          <button
            type="button"
            class="chat-filter-btn"
            [class.is-active]="isChatListFilterActive('GRUPOS')"
            (click)="setChatListFilter('GRUPOS')">
            Grupos
          </button>
        </div>
        <div class="chat-scroll">
          <div *ngFor="let chat of chatsFiltrados" class="chat-item" [class.chat-item--unread]="chat.unreadCount > 0"
            [class.chat-item--group]="chat.esGrupo"
            [class.chat-item--selected]="chat.id === chatSeleccionadoId"
            [class.chat-item--forward-mode]="forwardModalOpen"
            (click)="onChatItemClick(chat)">

            <label *ngIf="forwardModalOpen" class="forward-chat-check" (click)="$event.stopPropagation()">
              <input
                type="checkbox"
                [checked]="isForwardChatSelected(chat.id)"
                (change)="toggleForwardChat(chat.id, $event)"
                [disabled]="forwardingInProgress"
              />
            </label>

            <div class="foto-con-estado">
              <img [src]="chat.foto" alt="Foto" class="foto-perfil" />
              <span *ngIf="chat.esGrupo" class="badge-group" title="Grupo">
                <i class="bi bi-people-fill"></i>
              </span>
              <span *ngIf="chat.receptor" class="estado-icono" [ngClass]="{
                'conectado': chat.estado === 'Conectado',
                'desconectado': chat.estado === 'Desconectado',
                'ausente': chat.estado === 'Ausente'
              }" title="{{ chat.estado }}">
                <i class="bi" [ngClass]="{
                  'bi-check': chat.estado === 'Conectado',
                  'bi-x-circle-fill': chat.estado === 'Desconectado',
                  'bi bi-stopwatch ausente-icono': chat.estado === 'Ausente'
                }"></i>
              </span>
            </div>

            <div class="info-chat">
              <div class="nombre-linea">
                <span class="nombre">{{ chat.nombre }}</span>
                <span *ngIf="chat.esGrupo" class="pill pill--group">Grupo</span>
              </div>
              <div class="mensaje-preview" [class.preview-unread]="chat.unreadCount > 0">
                <ng-container *ngIf="
                  (chat.receptor && usuariosEscribiendo.has(chat.receptor.id) && chat.receptor.id !== chatActual?.receptor?.id)
                  || (chat.esGrupo && gruposEscribiendo.has(chat.id));
                  else ultimoMensaje
                ">
                  <em class="escribiendo-lista">
                    {{ chat.esGrupo ? (quienEscribeEnGrupo.get(chat.id) || 'Alguien') + ' está escribiendo...' :
                    'Escribiendo...' }}
                  </em>
                </ng-container>

                <ng-template #ultimoMensaje>
                  <ng-container *ngIf="isAudioPreviewChat(chat); else noAudioPrev">
                    <span class="preview-audio compact">
                      <span *ngIf="audioPreviewLabel(chat) === 'Tú'" class="me-label">Tú:</span>
                      <i class="fas fa-microphone" aria-hidden="true"></i>
                      <span class="sep">•</span>
                      <span class="time">{{ audioPreviewTime(chat) }}</span>
                    </span>
                    <span *ngIf="chat.unreadCount > 0" class="badge-inline">{{ chat.unreadCount }}</span>
                  </ng-container>

                  <ng-template #noAudioPrev>
                    <ng-container *ngIf="isImagePreviewChat(chat); else textoPrev">
                      <span class="preview-line preview-line--image">
                        <span *ngIf="imagePreviewSenderLabel(chat) as sender" class="preview-image-sender">
                          {{ sender }}:
                        </span>
                        <ng-container *ngIf="chatImagePreviewSrc(chat) as imageThumb; else imageThumbFallback">
                          <img class="preview-image-thumb" [src]="imageThumb" [alt]="chatImagePreviewAlt(chat)" />
                        </ng-container>
                        <ng-template #imageThumbFallback>
                          <span class="preview-image-thumb preview-image-thumb--fallback" aria-hidden="true">
                            <i class="bi bi-image"></i>
                          </span>
                        </ng-template>
                        <span *ngIf="imagePreviewCaption(chat) as caption" class="preview-text">
                          <span class="preview-caption-chip">“{{ caption }}”</span>
                        </span>
                        <span *ngIf="chat.unreadCount > 0" class="badge-inline">{{ chat.unreadCount }}</span>
                      </span>
                    </ng-container>
                  </ng-template>

                  <ng-template #textoPrev>
                    <span class="preview-line">
                      <span class="preview-text">{{ formatearPreview(chat) }}</span>
                      <span *ngIf="chat.unreadCount > 0" class="badge-inline">{{ chat.unreadCount }}</span>
                    </span>
                  </ng-template>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="zonaMensajes" *ngIf="activeMainView === 'chat'; else perfilView">
        <div *ngIf="chatSeleccionadoId !== null" class="encabezado-chat-mensajes">

          <button class="btn-back-mobile" (click)="chatSeleccionadoId = null">
            <i class="fas fa-arrow-left"></i>
          </button>

          <div class="info-usuario-chat">
            <img [src]="chatActual?.foto || 'assets/placeholder-user.png'" alt="Foto" class="foto-perfil-chat" />
            <div class="detalle-usuario-chat">
              <span class="nombre-usuario-chat">
                {{ chatActual?.nombre }}
                <div *ngIf="chatActual?.esGrupo && chatActual?.usuarios?.length" class="grupo-miembros"
                  [attr.title]="getMiembrosLinea(chatActual?.usuarios || [])">
                  <ng-container *ngFor="let u of chatActual.usuarios; let last = last">
                    <span class="miembro">{{ u.nombre }} {{ u.apellido }}</span><ng-container *ngIf="!last">,
                    </ng-container>
                  </ng-container>
                </div>
                <span *ngIf="chatActual?.receptor" class="estado-posicion-encabezado" [ngClass]="{
                  'estado-icono': true,
                  'conectado-header': chatActual?.estado === 'Conectado',
                  'desconectado-header': chatActual?.estado === 'Desconectado',
                  'ausente-header': chatActual?.estado === 'Ausente'
                }" title="{{ chatActual?.estado }}">
                  <i class="bi" [ngClass]="{
                    'bi-check': chatActual?.estado === 'Conectado',
                    'bi-x-circle-fill': chatActual?.estado === 'Desconectado',
                    'bi bi-stopwatch ausente-icono': chatActual?.estado === 'Ausente'
                  }"></i>
                </span>
              </span>
              <div *ngIf="!chatActual?.esGrupo && usuarioEscribiendo" class="escribiendo">
                <em>Escribiendo...</em>
              </div>
              <div *ngIf="chatActual?.esGrupo && escribiendoHeader" class="escribiendo">
                <em>{{ escribiendoHeader }}</em>
              </div>
            </div>
          </div>

          <div class="header-actions">
            <button *ngIf="chatActual?.esGrupo" class="btn-icon header-add-user" type="button"
              [attr.aria-expanded]="showGroupInfoPanel"
              [disabled]="haSalidoDelGrupo"
              [attr.title]="haSalidoDelGrupo ? 'No disponible: ya no eres miembro del grupo' : 'Info. del grupo'"
              (click)="toggleGroupInfoPanel($event)">
              <i class="bi bi-info-circle"></i>
            </button>
            <button *ngIf="chatActual && !chatActual.esGrupo" class="btn-icon header-video-call me-2" type="button"
              title="Iniciar videollamada" aria-label="Iniciar videollamada"
              (click)="iniciarVideollamada(chatActual?.id)">
              <i class="bi bi-camera-video"></i>
            </button>
            <i class="fas fa-ellipsis-v icono-opciones-chat" (click)="toggleMenuOpciones()"></i>
            <div class="dropdown-opciones" *ngIf="mostrarMenuOpciones" (mouseleave)="cerrarMenuOpciones()">
              <div class="dropdown-actions-box">
                <button class="dropdown-item dropdown-item--buscar"
                  (mousedown)="toggleMessageSearchPanel($event); $event.stopPropagation()">
                  <span class="icono-buscar" aria-hidden="true"><i class="bi bi-search"></i></span>
                  Buscar mensajes
                </button>
                <button *ngIf="chatActual?.esGrupo" class="dropdown-item dropdown-item--salir"
                  (mousedown)="salirDelGrupo(); $event.stopPropagation()">
                  <span class="icono-salir" aria-hidden="true"><i class="bi bi-box-arrow-right"></i></span>
                  Salir del grupo
                </button>
                <button class="dropdown-item" *ngIf="chatActual && !chatActual.esGrupo"
                  [ngClass]="yoLoBloquee ? 'dropdown-item--desbloquear' : 'dropdown-item--bloquear'"
                  (mousedown)="toggleBloquearUsuario(); $event.stopPropagation()">
                  <span class="icono-bloquear" aria-hidden="true"><i class="bi bi-slash-circle"></i></span>
                  {{ yoLoBloquee ? 'Desbloquear usuario' : 'Bloquear usuario' }}
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="cuerpo-mensajes" #contenedorMensajes (scroll)="onMessagesScroll()">
          <div *ngIf="chatSeleccionadoId === null" class="placeholder-chat">
            <i class="bi bi-chat-dots-fill"></i>
            <h3>TejeChat</h3>
            <p>Selecciona un chat para comenzar</p>
          </div>

          <div *ngIf="chatSeleccionadoId !== null && mensajesSeleccionados.length === 0 && !showGroupHistoryUnavailableNotice" class="placeholder-chat">
            <i class="bi bi-inbox"></i>
            <h3>No hay mensajes</h3>
            <p>Envía un mensaje para iniciar la conversación</p>
          </div>

          <div *ngIf="chatSeleccionadoId !== null && showGroupHistoryUnavailableNotice" class="mensaje-row mensaje-row--system">
            <div class="mensaje-system-card">
              <i class="bi bi-shield-lock" aria-hidden="true"></i>
              <span>{{ groupHistoryUnavailableText }}</span>
            </div>
          </div>

          <div *ngIf="showCallUI" class="call-overlay">
            <div class="call-window" [class.is-ended]="callStatusClass === 'is-ended'">
              <div class="remote-area">
                <video *ngIf="hasRemoteVideoActive" class="remote-video" [appMediaStream]="remoteStream" autoplay
                  playsinline></video>
                <div *ngIf="!hasRemoteVideoActive" class="remote-overlay" [ngClass]="callStatusClass">
                  <ng-container *ngIf="peerAvatarUrl; else remoteIcon">
                    <img [src]="peerAvatarUrl" alt="avatar" class="avatar" />
                  </ng-container>
                  <ng-template #remoteIcon>
                    <i class="bi bi-person-circle avatar-icon" aria-hidden="true"></i>
                  </ng-template>
                  <div class="peer-name">{{ peerDisplayName }}</div>
                  <div *ngIf="callInfoMessage" class="status-row">
                    <i class="bi" [ngClass]="{
                      'bi-telephone-fill': callStatusClass === 'is-ringing',
                      'bi-telephone-x-fill': callStatusClass === 'is-ended' || callStatusClass === 'is-error'
                    }"></i>
                    <span class="text">{{ callInfoMessage }}</span>
                  </div>
                </div>
              </div>
              <video class="local-video" [appMediaStream]="localStream" autoplay playsinline muted></video>
              <div class="call-controls">
                <button class="cc-btn" (click)="toggleMute()" [attr.aria-pressed]="isMuted">
                  <i class="bi" [ngClass]="isMuted ? 'bi-mic-mute-fill' : 'bi-mic-fill'"></i>
                </button>
                <button class="cc-btn" (click)="toggleCam()" [attr.aria-pressed]="camOff">
                  <i class="bi" [ngClass]="camOff ? 'bi-camera-video-off-fill' : 'bi-camera-video-fill'"></i>
                </button>
                <button class="cc-btn hang" (click)="colgar()">
                  <i class="bi bi-telephone-x-fill"></i>
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="ultimaInvite && !showCallUI" class="incoming-call-banner">
            <div class="caller">
              <strong>{{ ultimaInvite.callerNombre }} {{ ultimaInvite.callerApellido }}</strong> te está llamando…
            </div>
            <div class="actions">
              <button class="btn-accept" (click)="aceptarLlamada()"><i class="bi bi-telephone-inbound-fill"></i>
                Aceptar</button>
              <button class="btn-decline" (click)="rechazarLlamada()"><i class="bi bi-telephone-x-fill"></i>
                Rechazar</button>
            </div>
          </div>

          <div *ngIf="mensajesSeleccionados.length > 0" class="mensaje">
            <ng-container *ngFor="let mensaje of mensajesSeleccionados; let i = index; trackBy: trackMensaje">
              <div *ngIf="shouldShowDateSeparator(i)" class="message-day-separator">
                {{ getDateSeparatorLabel(mensaje) }}
              </div>
              <div *ngIf="isSystemMessage(mensaje)" class="mensaje-row mensaje-row--system">
                <div class="mensaje-system-card">
                  <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
                  <span>{{ mensaje.contenido }}</span>
                </div>
              </div>
              <div
                *ngIf="!isSystemMessage(mensaje)"
                class="mensaje-row"
                [class.es-propio]="mensaje.emisorId === usuarioActualId"
                [class.es-otro]="mensaje.emisorId !== usuarioActualId"
                [class.has-reaction]="!!incomingQuickReaction(mensaje)"
                [class.mensaje-row--search-target]="mensaje.id === highlightedMessageId"
                [attr.data-message-id]="mensaje.id ?? null">

                <img *ngIf="chatActual?.esGrupo && mensaje.emisorId !== usuarioActualId" class="msg-avatar-left"
                  [src]="mensaje.emisorFoto || getAvatarFallback(mensaje.emisorId)" alt="Avatar emisor" />

                <div class="mensaje"
                  [ngClass]="mensaje.emisorId === usuarioActualId ? 'mensaje-propio' : 'mensaje-otro'">

                  <div *ngIf="chatActual?.esGrupo && mensaje.emisorId !== usuarioActualId" class="msg-name-inline"
                    [style.color]="getNameColor(mensaje.emisorId)">
                    {{ mensaje.emisorNombre || obtenerNombrePorId(mensaje.emisorId) }}
                    {{ mensaje.emisorApellido || '' }}
                  </div>

                  <span class="contenido-mensaje" [class.mensaje-eliminado]="mensaje.activo === false" [class.contenido-mensaje--reenviado]="mensaje.reenviado">
                    <span *ngIf="mensaje.reenviado" class="msg-forwarded-label">
                      <i class="bi bi-reply-fill"></i> Reenviado
                    </span>
                    <ng-container *ngIf="mensaje.activo === false; else contenidoNormal">
                      <i class="bi bi-slash-circle" aria-hidden="true"></i>
                      {{ mensaje.emisorId === usuarioActualId ? 'Eliminaste este mensaje.' : 'Este mensaje ha sido
                      eliminado.' }}
                    </ng-container>

                    <ng-template #contenidoNormal>
                      <span *ngIf="mensaje.replyToMessageId" class="msg-reply-ref">
                        <span class="msg-reply-ref__author">{{ getReplyAuthorLabel(mensaje) }}</span>
                        <span class="msg-reply-ref__text">{{ getReplySnippet(mensaje) }}</span>
                      </span>
                      <ng-container *ngIf="(mensaje.tipo || 'TEXT') === 'AUDIO'; else contenidoNoAudio">
                        <ng-container *ngIf="getAudioSrc(mensaje) as audioSrc; else audioCipherMissing">
                          <div class="audio-bubble" [class.mine]="mensaje.emisorId === usuarioActualId">
                            <button class="audio-play"
                              [attr.aria-label]="(audioStates.get(mensaje.id!)?.playing ? 'Pausar' : 'Reproducir') + ' audio'"
                              (click)="togglePlay(mensaje, audioRef)">
                              <i class="fas"
                                [ngClass]="audioStates.get(mensaje.id!)?.playing ? 'fa-pause' : 'fa-play'"></i>
                            </button>
                            <div class="audio-wave">
                              <div class="audio-track">
                                <div class="audio-progress" [style.width.%]="progressPercent(mensaje)"></div>
                              </div>
                              <div class="audio-time">
                                {{ formatDur(audioStates.get(mensaje.id!)?.current) || formatDur(mensaje.audioDuracionMs)
                                }}
                              </div>
                            </div>
                            <audio #audioRef [src]="audioSrc"
                              (loadedmetadata)="onAudioLoadedMetadata(mensaje, audioRef)"
                              (timeupdate)="onAudioTimeUpdate(mensaje, audioRef)" (ended)="onAudioEnded(mensaje)"></audio>
                          </div>
                        </ng-container>
                        <ng-template #audioCipherMissing>
                          <span class="msg-text-inline">[Mensaje de voz cifrado]</span>
                        </ng-template>
                      </ng-container>

                      <ng-template #contenidoNoAudio>
                        <ng-container *ngIf="(mensaje.tipo || 'TEXT') === 'IMAGE'; else contenidoTexto">
                          <span class="msg-image-inline-wrap">
                            <ng-container *ngIf="getImageSrc(mensaje) as imageSrc; else imageCipherMissing">
                              <span class="image-bubble" [class.mine]="mensaje.emisorId === usuarioActualId">
                                <img class="msg-image" [src]="imageSrc" [alt]="getImageAlt(mensaje)" />
                                <span *ngIf="mensaje.contenido" class="msg-image-caption">
                                  {{ mensaje.contenido }}
                                </span>
                              </span>
                            </ng-container>
                            <ng-template #imageCipherMissing>
                              <span class="msg-text-inline">[Imagen cifrada]</span>
                            </ng-template>
                            <span class="msg-meta-inline msg-meta-inline--image">
                              <span class="msg-time">{{ formatMensajeHora(mensaje) }}</span>
                              <i
                                *ngIf="mensaje.emisorId === usuarioActualId"
                                class="bi bi-check2-all double-check"
                                [ngClass]="mensaje.leido ? 'leido' : 'no-leido'"
                              ></i>
                            </span>
                          </span>
                        </ng-container>

                        <ng-template #contenidoTexto>
                          <span class="msg-text-inline">
                            <span (mouseup)="onMessageMouseUp(mensaje, textHost)" #textHost>
                              {{ mensaje.contenido }}
                            </span>
                            <span class="msg-meta-inline msg-meta-inline--end">
                              <span class="msg-time">{{ formatMensajeHora(mensaje) }}</span>
                              <i
                                *ngIf="mensaje.emisorId === usuarioActualId"
                                class="bi bi-check2-all double-check"
                                [ngClass]="mensaje.leido ? 'leido' : 'no-leido'"
                              ></i>
                            </span>
                          </span>
                        </ng-template>
                      </ng-template>
                      <span class="msg-meta-inline" *ngIf="(mensaje.tipo || 'TEXT') !== 'TEXT' && (mensaje.tipo || 'TEXT') !== 'IMAGE'">
                        <span class="msg-time">{{ formatMensajeHora(mensaje) }}</span>
                        <i
                          *ngIf="mensaje.emisorId === usuarioActualId"
                          class="bi bi-check2-all double-check"
                          [ngClass]="mensaje.leido ? 'leido' : 'no-leido'"
                        ></i>
                      </span>
                    </ng-template>
                  </span>

                  <div
                    *ngIf="mensaje.activo"
                    class="menu-opciones"
                    [class.menu-opciones--open]="openMensajeMenuId === mensaje.id"
                  >
                    <button
                      type="button"
                      class="btn-menu-mensaje"
                      [class.btn-menu-mensaje--open]="openMensajeMenuId === mensaje.id"
                      aria-label="Abrir opciones del mensaje"
                      [attr.aria-expanded]="openMensajeMenuId === mensaje.id"
                      (click)="toggleMensajeMenu(mensaje, $event)"
                    >
                      <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <div class="opciones-collapse" *ngIf="openMensajeMenuId === mensaje.id" (click)="$event.stopPropagation()">
                      <button type="button" class="btn-opcion-responder" (click)="responderMensaje(mensaje, $event)">
                        <i class="bi bi-reply"></i> Responder
                      </button>
                      <button
                        *ngIf="mensaje.emisorId === usuarioActualId"
                        type="button"
                        class="btn-opcion-reenviar"
                        (click)="abrirModalReenvio(mensaje, $event)"
                      >
                        <i class="bi bi-reply-fill"></i> Reenviar
                      </button>
                      <button
                        *ngIf="mensaje.emisorId === usuarioActualId"
                        type="button"
                        class="btn-opcion-eliminar"
                        (click)="eliminarMensaje(mensaje); $event.stopPropagation()"
                      >
                        <i class="bi bi-trash"></i> Eliminar
                      </button>
                    </div>
                  </div>

                  <div *ngIf="incomingQuickReaction(mensaje) as reaction" class="msg-reaction-row">
                    <span class="msg-reaction-pill">{{ reaction }}</span>
                  </div>

                </div>

                <div
                  *ngIf="canToggleIncomingQuickReaction(mensaje)"
                  class="msg-reaction-box"
                  (click)="$event.stopPropagation()"
                >
                  <button
                    type="button"
                    class="btn-msg-react"
                    [attr.aria-label]="'Reaccionar al mensaje'"
                    [attr.aria-expanded]="isIncomingReactionPickerOpen(mensaje)"
                    (click)="toggleIncomingReactionPicker(mensaje, $event)"
                  >
                    <i class="bi bi-emoji-smile"></i>
                  </button>
                  <div
                    *ngIf="isIncomingReactionPickerOpen(mensaje)"
                    class="msg-reaction-picker"
                  >
                    <button
                      type="button"
                      class="msg-reaction-option"
                      *ngFor="let emoji of incomingReactionChoices"
                      (click)="applyIncomingQuickReaction(mensaje, emoji, $event)"
                    >
                      {{ emoji }}
                    </button>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>

        <div class="ai-panel" *ngIf="aiPanelOpen">
          <div class="ai-panel__header">
            <span>Preguntarle a la IA</span>
            <button type="button" class="ai-close" (click)="cancelAiPanel()" title="Cerrar">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>

        <div *ngIf="chatSeleccionadoId !== null" class="entrada-mensaje">
          <div *ngIf="forwardModalOpen; else composeMode" class="forward-bottom-actions">
            <div class="forward-target-count">Chats seleccionados: {{ forwardSelectedChatIds.size }}</div>
            <div class="forward-inline-actions">
              <button
                type="button"
                class="btn-forward-send"
                (click)="confirmarReenvioMensaje()"
                [disabled]="forwardingInProgress || forwardSelectedChatIds.size === 0"
              >
                <i class="fas fa-paper-plane"></i>
                {{ forwardingInProgress ? 'Reenviando...' : 'Reenviar' }}
              </button>
              <button
                type="button"
                class="btn-forward-cancel-x"
                (click)="cerrarModalReenvio()"
                [disabled]="forwardingInProgress"
                title="Cancelar reenvío"
                aria-label="Cancelar reenvío"
              >
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>

          <ng-template #composeMode>
            <div *ngIf="mensajeRespuestaObjetivo" class="reply-compose-banner">
              <div class="reply-compose-banner__meta">
                <span class="reply-compose-banner__label">Respondiendo a {{ mensajeRespuestaObjetivo.emisorId === usuarioActualId ? 'Tú' : (mensajeRespuestaObjetivo.emisorNombre || obtenerNombrePorId(mensajeRespuestaObjetivo.emisorId) || 'Usuario') }}</span>
                <span class="reply-compose-banner__text">
                  {{ (mensajeRespuestaObjetivo.tipo || 'TEXT') === 'AUDIO' ? 'Mensaje de voz' : mensajeRespuestaObjetivo.contenido }}
                </span>
              </div>
              <button
                type="button"
                class="reply-compose-banner__close"
                (click)="cancelarRespuestaMensaje()"
                title="Cancelar respuesta"
                aria-label="Cancelar respuesta"
              >
                <i class="bi bi-x-lg"></i>
              </button>
            </div>

            <div *ngIf="pendingAttachmentFile" class="attachment-preview">
              <button
                type="button"
                class="attachment-preview__remove"
                title="Quitar adjunto"
                aria-label="Quitar adjunto"
                (click)="clearPendingAttachment()"
              >
                <i class="bi bi-x-lg"></i>
              </button>
              <ng-container *ngIf="pendingAttachmentIsImage && pendingAttachmentPreviewUrl; else genericAttachmentCard">
                <img
                  class="attachment-preview__image"
                  [src]="pendingAttachmentPreviewUrl"
                  [alt]="pendingAttachmentFile.name"
                />
                <div class="attachment-preview__caption">
                  {{ pendingAttachmentFile.name }} · {{ formatAttachmentSize(pendingAttachmentFile.size) }}
                </div>
              </ng-container>
              <ng-template #genericAttachmentCard>
                <div class="attachment-preview__file-card">
                  <i class="bi bi-file-earmark"></i>
                  <div class="attachment-preview__meta">
                    <div class="attachment-preview__name">{{ pendingAttachmentFile.name }}</div>
                    <div class="attachment-preview__size">{{ formatAttachmentSize(pendingAttachmentFile.size) }}</div>
                  </div>
                </div>
              </ng-template>
            </div>

            <div *ngIf="!recording; else grabandoUI" class="compose-row">
              <button
                type="button"
                class="btn-attach"
                [disabled]="attachmentUploading || haSalidoDelGrupo || chatEstaBloqueado || noGroupRecipientsForSend"
                [title]="attachmentUploading ? 'Subiendo archivo...' : 'Adjuntar archivo'"
                aria-label="Adjuntar archivo"
                (click)="openAttachmentPicker($event)"
              >
                <i class="bi bi-paperclip"></i>
              </button>
              <input
                #attachmentInput
                type="file"
                class="attachment-input-hidden"
                (change)="onAttachmentSelected($event)"
                accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar"
              />

              <div #emojiAnchor class="emoji-anchor">
                <button
                  type="button"
                  class="btn-emoji"
                  [class.btn-emoji--active]="showEmojiPicker"
                  [disabled]="haSalidoDelGrupo || chatEstaBloqueado"
                  [title]="haSalidoDelGrupo || chatEstaBloqueado ? 'No disponible' : 'Abrir emoticonos'"
                  aria-label="Abrir emoticonos"
                  (click)="toggleEmojiPicker($event)"
                >
                  <i class="bi bi-emoji-smile"></i>
                </button>
                <app-emoji-picker
                  *ngIf="showEmojiPickerMounted"
                  class="emoji-picker-pop"
                  [class.is-open]="showEmojiPicker"
                  (emojiSelect)="onEmojiSelected($event)"
                ></app-emoji-picker>
              </div>

              <textarea #messageInput [(ngModel)]="mensajeNuevo" (keydown)="onKeydown($event)" (keydown.enter)="onEnter($event)"
                (click)="onMessageInputSelectionChange()" (keyup)="onMessageInputSelectionChange()"
                (select)="onMessageInputSelectionChange()" (focus)="onMessageInputSelectionChange()"
                [placeholder]="chatEstaBloqueado ? (yoLoBloquee ? 'Has bloqueado a este usuario.' : 'Estás bloqueado por este usuario.') : 'Escribe un mensaje...'"
                class="input-mensaje" [disabled]="chatEstaBloqueado" [readonly]="haSalidoDelGrupo"
                [class.input-mensaje--loading]="aiLoading"
                [class.input-mensaje--salido]="haSalidoDelGrupo || chatEstaBloqueado"
                [class.input-mensaje--replying]="!!mensajeRespuestaObjetivo"
                [title]="chatEstaBloqueado ? (yoLoBloquee ? 'Has bloqueado a este usuario' : 'Estás bloqueado') : (noGroupRecipientsForSend ? 'Todavia no ha aceptado nadie' : '')">
              </textarea>
              <button class="btn-mic"
                [title]="chatEstaBloqueado ? (yoLoBloquee ? 'Has bloqueado a este usuario' : 'Estás bloqueado') : (noGroupRecipientsForSend ? 'Todavia no ha aceptado nadie' : 'Grabar audio')"
                (click)="startRecording()" [disabled]="haSalidoDelGrupo || chatEstaBloqueado || noGroupRecipientsForSend"
                [class.btn-disabled-block]="chatEstaBloqueado">
                <i class="fas fa-microphone"></i>
              </button>
              <button class="btn-enviar"
                [title]="chatEstaBloqueado ? (yoLoBloquee ? 'Has bloqueado a este usuario' : 'Estás bloqueado') : (noGroupRecipientsForSend ? 'Todavia no ha aceptado nadie' : 'Enviar mensaje')"
                (click)="enviarMensajeDesdeComposer()" [disabled]="attachmentUploading || aiLoading || chatEstaBloqueado || haSalidoDelGrupo || noGroupRecipientsForSend"
                [class.btn-disabled-block]="chatEstaBloqueado">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>

            <ng-template #grabandoUI>
              <div class="rec-wrapper">
                <button class="btn-mic recording" disabled title="Grabando...">
                  <span class="rec-dot" aria-hidden="true"></span>
                  <i class="fas fa-microphone"></i>
                </button>
                <div class="rec-visual" aria-live="polite">
                  <div class="rec-wave" aria-hidden="true">
                    <span class="bar" *ngFor="let _ of recBars; trackBy: trackIndex"></span>
                  </div>
                  <span class="rec-timer">{{ formatDur(recordElapsedMs) }}</span>
                </div>
                <button class="btn-send-audio" title="Enviar audio" (click)="stopRecordingAndSend()">
                  <i class="fas fa-paper-plane"></i>
                </button>
                <button class="btn-cancel-rec" title="Cancelar grabación" (click)="cancelRecording()">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </ng-template>
          </ng-template>
        </div>
      </div>
      <ng-template #perfilView>
        <div class="zonaMensajes zonaMensajes--perfil">
          <app-perfil-usuario
            [usuario]="perfilUsuario"
            [fotoUrl]="usuarioFotoUrl || ''"
            [passwordCodeRequested]="profilePasswordCodeRequested"
            [saving]="profileSaving"
            [codeTimeLeftSec]="profileCodeTimeLeftSec"
            (close)="closeProfileView()"
            (save)="onPerfilSave($event)"
            (confirmPassword)="onPerfilConfirmPassword($event)">
          </app-perfil-usuario>
        </div>
      </ng-template>

      <app-group-info-panel
        *ngIf="activeMainView === 'chat' && chatActual?.esGrupo && showGroupInfoPanelMounted"
        class="group-info-col"
        [class.is-open]="showGroupInfoPanel"
        [group]="chatActual"
        [currentUserId]="usuarioActualId"
        (closePanel)="closeGroupInfoPanel()"
        (leaveGroup)="onLeaveGroupFromInfoPanel()">
      </app-group-info-panel>

      <app-message-search-panel
        *ngIf="activeMainView === 'chat' && chatActual && showMessageSearchPanelMounted"
        class="message-search-col"
        [class.is-open]="showMessageSearchPanel"
        [chat]="chatActual"
        [messages]="mensajesSeleccionados"
        [currentUserId]="usuarioActualId"
        (openMessage)="onMessageSearchResultSelect($event)"
        (closePanel)="closeMessageSearchPanel()">
      </app-message-search-panel>
    </div>
  </div>
</div>

<app-crear-grupo-modal #crearGrupoModal [currentUserId]="usuarioActualId"
  (create)="onCrearGrupo($event)"></app-crear-grupo-modal>



