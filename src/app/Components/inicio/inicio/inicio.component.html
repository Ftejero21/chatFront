<div class="imagenPrincipal">
  <div class="contenedorChat">

    <header class="topbar">
      <div class="topbar__left">
        <i class="fas fa-bars topbar__menu-movil"></i>
        <i class="fas fa-comments topbar__logo"></i>
        <span class="topbar__brand">TejeChat</span>
      </div>

      <div class="topbar__search">
        <i class="bi bi-search topbar__search-icon"></i>
        <input type="search" class="topbar__search-input" placeholder="Buscar o iniciar un chat" [value]="topbarQuery"
          (input)="onTopbarSearch($event)" (focus)="topbarOpen = !!topbarResults.length" />

        <div class="topbar__results collapse" [class.show]="topbarOpen" (mousedown)="$event.preventDefault()">
          <div *ngIf="topbarSearching" class="result-row muted">Buscando‚Ä¶</div>
          <div *ngIf="!topbarSearching && topbarResults.length === 0" class="result-row muted">Sin resultados</div>
          <button type="button" class="result-row" *ngFor="let u of topbarResults; trackBy: trackIndex"
            (click)="onTopbarResultClick(u)">
            <div class="result-avatar-wrap">
              <img [src]="avatarOrDefaultUser(u)" alt="" class="result-avatar" />
              <span class="estado-icono-topbar" [ngClass]="{
                  'conectado-topbar': u.estado === 'Conectado',
                  'desconectado-topbar': !u.estado || u.estado === 'Desconectado',
                  'ausente-topbar': u.estado === 'Ausente'
                }" [attr.title]="u.estado || 'Desconectado'">
                <i class="bi" [ngClass]="{
                    'bi-check': u.estado === 'Conectado',
                    'bi-x-circle-fill': !u.estado || u.estado === 'Desconectado',
                    'bi bi-stopwatch ausente-icono-topbar': u.estado === 'Ausente'
                  }"></i>
              </span>
            </div>
            <div class="full-name">{{ nombreCompleto(u) }}</div>
            <div class="email">{{ u.email }}</div>
          </button>
        </div>
      </div>

      <div class="topbar__right">
        <div class="notif-wrapper" [class.open]="panelNotificacionesAbierto">
          <button class="topbar__btn notif-btn" title="Notificaciones" aria-label="Notificaciones"
            (click)="togglePanelNotificaciones()">
            <i class="fas fa-bell"></i>
            <span *ngIf="invitePendingCount > 0" class="notif-badge">
              {{ invitePendingCount <= 99 ? invitePendingCount : '99+' }} </span>
          </button>
          <div class="notif-panel" *ngIf="panelNotificacionesAbierto">
            <div class="notif-header">Notificaciones</div>
            <ng-container *ngIf="notifInvites.length else notifEmpty">
              <div *ngFor="let n of notifInvites" class="notif-card">
                <div class="notif-text">
                  <strong>{{ n.inviterNombre }}</strong> te invita al grupo <strong>‚Äú{{ n.groupName }}‚Äù</strong>
                </div>
                <div class="notif-actions">
                  <button class="btn-add-user" (click)="aceptarInvitacion(n)">Aceptar</button>
                  <button class="btn-opcion-eliminar" (click)="rechazarInvitacion(n)">Cancelar</button>
                </div>
              </div>
            </ng-container>
            <ng-template #notifEmpty>
              <div class="notif-empty">Sin notificaciones</div>
            </ng-template>
          </div>
        </div>
        <button class="topbar__btn" title="Ajustes"><i class="fas fa-cog"></i></button>
        <img [src]="usuarioFotoUrl || '/assets/usuario.png'" alt="Perfil" class="topbar__avatar" />
      </div>
    </header>

    <div class="cuerpoChat" [class.modo-chat-movil]="chatSeleccionadoId !== null">

      <div class="barraLateral">
        <div class="iconos-superiores">
          <i class="fas fa-home icono-barra"></i>
          <i class="fas fa-comment icono-barra active"></i>
          <i class="fas fa-star icono-barra"></i>
        </div>
        <div class="usuario-config">
          <img [src]="usuarioFotoUrl || '/assets/usuario.png'" alt="Perfil" class="topbar__avatar" />
          <i class="fas fa-cog icono-barra"></i>
        </div>
      </div>

      <div class="listadoChats">
        <div class="encabezado-chats">
          <div class="titulo-chat">TejeChat</div>
          <div class="acciones-chat">
            <button class="icono-chat" title="Crear grupo" data-bs-toggle="modal" (click)="crearGrupoModal.open()"
              data-bs-target="#crearGrupoModal">
              <i class="fas fa-users"></i>
            </button>
            <i class="fas fa-ellipsis-v icono-chat" title="Opciones"></i>
          </div>
        </div>

        <div class="buscador">
          <input type="text" placeholder="Buscar personas..." class="input-busqueda" [value]="busquedaChat"
            (input)="onSearchChange($event)" />
        </div>

        <div class="chat-scroll">
          <div *ngFor="let chat of chatsFiltrados" class="chat-item" [class.chat-item--unread]="chat.unreadCount > 0"
            [class.chat-item--group]="chat.esGrupo" (click)="mostrarMensajes(chat)">

            <div class="foto-con-estado">
              <img [src]="chat.foto" alt="Foto" class="foto-perfil" />
              <span *ngIf="chat.esGrupo" class="badge-group" title="Grupo">
                <i class="bi bi-people-fill"></i>
              </span>
              <span *ngIf="chat.receptor" class="estado-icono" [ngClass]="{
                'conectado': chat.estado === 'Conectado',
                'desconectado': chat.estado === 'Desconectado',
                'ausente': chat.estado === 'Ausente'
              }" title="{{ chat.estado }}">
                <i class="bi" [ngClass]="{
                  'bi-check': chat.estado === 'Conectado',
                  'bi-x-circle-fill': chat.estado === 'Desconectado',
                  'bi bi-stopwatch ausente-icono': chat.estado === 'Ausente'
                }"></i>
              </span>
            </div>

            <div class="info-chat">
              <div class="nombre-linea">
                <span class="nombre">{{ chat.nombre }}</span>
                <span *ngIf="chat.esGrupo" class="pill pill--group">Grupo</span>
              </div>
              <div class="mensaje-preview" [class.preview-unread]="chat.unreadCount > 0">
                <ng-container *ngIf="
                  (chat.receptor && usuariosEscribiendo.has(chat.receptor.id) && chat.receptor.id !== chatActual?.receptor?.id)
                  || (chat.esGrupo && gruposEscribiendo.has(chat.id));
                  else ultimoMensaje
                ">
                  <em class="escribiendo-lista">
                    {{ chat.esGrupo ? (quienEscribeEnGrupo.get(chat.id) || 'Alguien') + ' est√° escribiendo...' :
                    'Escribiendo...' }}
                  </em>
                </ng-container>

                <ng-template #ultimoMensaje>
                  <ng-container *ngIf="isAudioPreviewChat(chat); else textoPrev">
                    <span class="preview-audio compact">
                      <span *ngIf="audioPreviewLabel(chat) === 'T√∫'" class="me-label">T√∫:</span>
                      <i class="fas fa-microphone" aria-hidden="true"></i>
                      <span class="sep">‚Ä¢</span>
                      <span class="time">{{ audioPreviewTime(chat) }}</span>
                    </span>
                    <span *ngIf="chat.unreadCount > 0" class="badge-inline">{{ chat.unreadCount }}</span>
                  </ng-container>

                  <ng-template #textoPrev>
                    <span class="preview-line">
                      <span class="preview-text">{{ formatearPreview(chat) }}</span>
                      <span *ngIf="chat.unreadCount > 0" class="badge-inline">{{ chat.unreadCount }}</span>
                    </span>
                  </ng-template>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="zonaMensajes">
        <div *ngIf="chatSeleccionadoId !== null" class="encabezado-chat-mensajes">

          <button class="btn-back-mobile" (click)="chatSeleccionadoId = null">
            <i class="fas fa-arrow-left"></i>
          </button>

          <div class="info-usuario-chat">
            <img [src]="chatActual?.foto || 'assets/placeholder-user.png'" alt="Foto" class="foto-perfil-chat" />
            <div class="detalle-usuario-chat">
              <span class="nombre-usuario-chat">
                {{ chatActual?.nombre }}
                <div *ngIf="chatActual?.esGrupo && chatActual?.usuarios?.length" class="grupo-miembros"
                  [attr.title]="getMiembrosLinea(chatActual?.usuarios || [])">
                  <ng-container *ngFor="let u of chatActual.usuarios; let last = last">
                    <span class="miembro">{{ u.nombre }} {{ u.apellido }}</span><ng-container *ngIf="!last">,
                    </ng-container>
                  </ng-container>
                </div>
                <span *ngIf="chatActual?.receptor" class="estado-posicion-encabezado" [ngClass]="{
                  'estado-icono': true,
                  'conectado-header': chatActual?.estado === 'Conectado',
                  'desconectado-header': chatActual?.estado === 'Desconectado',
                  'ausente-header': chatActual?.estado === 'Ausente'
                }" title="{{ chatActual?.estado }}">
                  <i class="bi" [ngClass]="{
                    'bi-check': chatActual?.estado === 'Conectado',
                    'bi-x-circle-fill': chatActual?.estado === 'Desconectado',
                    'bi bi-stopwatch ausente-icono': chatActual?.estado === 'Ausente'
                  }"></i>
                </span>
              </span>
              <div *ngIf="!chatActual?.esGrupo && usuarioEscribiendo" class="escribiendo">
                <em>Escribiendo...</em>
              </div>
              <div *ngIf="chatActual?.esGrupo && escribiendoHeader" class="escribiendo">
                <em>{{ escribiendoHeader }}</em>
              </div>
            </div>
          </div>

          <div class="header-actions">
            <button *ngIf="chatActual?.esGrupo" class="btn-icon header-add-user" type="button" data-bs-toggle="collapse"
              [attr.data-bs-target]="'#addUserPanel-'+chatActual?.id" aria-expanded="false"
              [attr.aria-controls]="'addUserPanel-'+chatActual?.id" title="A√±adir personas al grupo">
              <i class="bi bi-person-plus"></i>
            </button>
            <button *ngIf="chatActual && !chatActual.esGrupo" class="btn-icon header-video-call me-2" type="button"
              title="Iniciar videollamada" aria-label="Iniciar videollamada"
              (click)="iniciarVideollamada(chatActual?.id)">
              <i class="bi bi-camera-video"></i>
            </button>
            <i class="fas fa-ellipsis-v icono-opciones-chat" (click)="toggleMenuOpciones()"></i>
            <div class="dropdown-opciones" *ngIf="mostrarMenuOpciones" (mouseleave)="cerrarMenuOpciones()">
              <button class="dropdown-item dropdown-item--salir" *ngIf="chatActual?.esGrupo"
                (mousedown)="salirDelGrupo(); $event.stopPropagation()">
                <span class="icono-salir" aria-hidden="true">üö™</span>
                Salir del grupo
              </button>
              <button class="dropdown-item" *ngIf="chatActual && !chatActual.esGrupo"
                (mousedown)="toggleBloquearUsuario(); $event.stopPropagation()">
                <span class="icono-bloquear" aria-hidden="true">üö´</span>
                {{ yoLoBloquee ? 'Desbloquear usuario' : 'Bloquear usuario' }}
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="chatActual?.esGrupo" class="collapse add-user-panel" [id]="'addUserPanel-'+chatActual?.id">
          <div *ngFor="let u of candidatosAgregar" class="add-user-item">
            <img [src]="u.foto || 'assets/usuario.png'" class="add-user-avatar" alt="Avatar" />
            <div class="add-user-content">
              <div class="add-user-name">{{ u.nombre }} {{ u.apellido }}</div>
              <hr class="add-user-sep" />
              <button type="button" class="btn-add-user" (click)="agregarUsuarioAlGrupo(u)">
                <i class="bi bi-person-plus"></i> A√±adir usuario al grupo
              </button>
            </div>
          </div>
          <div *ngIf="candidatosAgregar?.length === 0" class="add-user-empty">
            <i class="bi bi-people"></i>
            <span>No hay usuarios sugeridos</span>
          </div>
        </div>
        <div *ngIf="chatActual?.esGrupo" class="collapse add-user-panel" [id]="'addUserPanel-'+chatActual?.id">
          <div class="group-users-list">
            <div *ngFor="let u of chatActual?.usuarios" class="group-user-row">
              <img [src]="u.foto || 'assets/usuario.png'" alt="Avatar" class="group-user-avatar" />
              <div class="group-user-name">{{ u.nombre }} {{ u.apellido }}</div>
            </div>
          </div>
          <div class="text-sep">
            <hr>
          </div>
          <button type="button" class="btn-add-users">Agregar usuarios</button>
        </div>

        <div class="cuerpo-mensajes" #contenedorMensajes>
          <div *ngIf="chatSeleccionadoId === null" class="placeholder-chat">
            <i class="bi bi-chat-dots-fill"></i>
            <h3>TejeChat</h3>
            <p>Selecciona un chat para comenzar</p>
          </div>

          <div *ngIf="chatSeleccionadoId !== null && mensajesSeleccionados.length === 0" class="placeholder-chat">
            <i class="bi bi-inbox"></i>
            <h3>No hay mensajes</h3>
            <p>Env√≠a un mensaje para iniciar la conversaci√≥n</p>
          </div>

          <div *ngIf="showCallUI" class="call-overlay">
            <div class="call-window" [class.is-ended]="callStatusClass === 'is-ended'">
              <div class="remote-area">
                <video *ngIf="hasRemoteVideoActive" class="remote-video" [appMediaStream]="remoteStream" autoplay
                  playsinline></video>
                <div *ngIf="!hasRemoteVideoActive" class="remote-overlay" [ngClass]="callStatusClass">
                  <ng-container *ngIf="peerAvatarUrl; else remoteIcon">
                    <img [src]="peerAvatarUrl" alt="avatar" class="avatar" />
                  </ng-container>
                  <ng-template #remoteIcon>
                    <i class="bi bi-person-circle avatar-icon" aria-hidden="true"></i>
                  </ng-template>
                  <div class="peer-name">{{ peerDisplayName }}</div>
                  <div *ngIf="callInfoMessage" class="status-row">
                    <i class="bi" [ngClass]="{
                      'bi-telephone-fill': callStatusClass === 'is-ringing',
                      'bi-telephone-x-fill': callStatusClass === 'is-ended' || callStatusClass === 'is-error'
                    }"></i>
                    <span class="text">{{ callInfoMessage }}</span>
                  </div>
                </div>
              </div>
              <video class="local-video" [appMediaStream]="localStream" autoplay playsinline muted></video>
              <div class="call-controls">
                <button class="cc-btn" (click)="toggleMute()" [attr.aria-pressed]="isMuted">
                  <i class="bi" [ngClass]="isMuted ? 'bi-mic-mute-fill' : 'bi-mic-fill'"></i>
                </button>
                <button class="cc-btn" (click)="toggleCam()" [attr.aria-pressed]="camOff">
                  <i class="bi" [ngClass]="camOff ? 'bi-camera-video-off-fill' : 'bi-camera-video-fill'"></i>
                </button>
                <button class="cc-btn hang" (click)="colgar()">
                  <i class="bi bi-telephone-x-fill"></i>
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="ultimaInvite && !showCallUI" class="incoming-call-banner">
            <div class="caller">
              <strong>{{ ultimaInvite.callerNombre }} {{ ultimaInvite.callerApellido }}</strong> te est√° llamando‚Ä¶
            </div>
            <div class="actions">
              <button class="btn-accept" (click)="aceptarLlamada()"><i class="bi bi-telephone-inbound-fill"></i>
                Aceptar</button>
              <button class="btn-decline" (click)="rechazarLlamada()"><i class="bi bi-telephone-x-fill"></i>
                Rechazar</button>
            </div>
          </div>

          <div *ngIf="mensajesSeleccionados.length > 0" class="mensaje">
            <ng-container *ngFor="let mensaje of mensajesSeleccionados; trackBy: trackMensaje">
              <div class="mensaje-row" [class.es-propio]="mensaje.emisorId === usuarioActualId"
                [class.es-otro]="mensaje.emisorId !== usuarioActualId">

                <img *ngIf="chatActual?.esGrupo && mensaje.emisorId !== usuarioActualId" class="msg-avatar-left"
                  [src]="mensaje.emisorFoto || getAvatarFallback(mensaje.emisorId)" alt="Avatar emisor" />

                <div class="mensaje"
                  [ngClass]="mensaje.emisorId === usuarioActualId ? 'mensaje-propio' : 'mensaje-otro'">

                  <div *ngIf="chatActual?.esGrupo && mensaje.emisorId !== usuarioActualId" class="msg-name-inline"
                    [style.color]="getNameColor(mensaje.emisorId)">
                    {{ mensaje.emisorNombre || obtenerNombrePorId(mensaje.emisorId) }}
                    {{ mensaje.emisorApellido || '' }}
                  </div>

                  <span class="contenido-mensaje" [class.mensaje-eliminado]="mensaje.activo === false">
                    <ng-container *ngIf="mensaje.activo === false; else contenidoNormal">
                      <i class="bi bi-slash-circle" aria-hidden="true"></i>
                      {{ mensaje.emisorId === usuarioActualId ? 'Eliminaste este mensaje.' : 'Este mensaje ha sido
                      eliminado.' }}
                    </ng-container>

                    <ng-template #contenidoNormal>
                      <ng-container *ngIf="(mensaje.tipo || 'TEXT') === 'AUDIO'; else contenidoTexto">
                        <div class="audio-bubble" [class.mine]="mensaje.emisorId === usuarioActualId">
                          <button class="audio-play"
                            [attr.aria-label]="(audioStates.get(mensaje.id!)?.playing ? 'Pausar' : 'Reproducir') + ' audio'"
                            (click)="togglePlay(mensaje, audioRef)">
                            <i class="fas"
                              [ngClass]="audioStates.get(mensaje.id!)?.playing ? 'fa-pause' : 'fa-play'"></i>
                          </button>
                          <div class="audio-wave">
                            <div class="audio-track">
                              <div class="audio-progress" [style.width.%]="progressPercent(mensaje)"></div>
                            </div>
                            <div class="audio-time">
                              {{ formatDur(audioStates.get(mensaje.id!)?.current) || formatDur(mensaje.audioDuracionMs)
                              }}
                            </div>
                          </div>
                          <audio #audioRef [src]="getAudioSrc(mensaje)"
                            (loadedmetadata)="onAudioLoadedMetadata(mensaje, audioRef)"
                            (timeupdate)="onAudioTimeUpdate(mensaje, audioRef)" (ended)="onAudioEnded(mensaje)"></audio>
                        </div>
                      </ng-container>

                      <ng-template #contenidoTexto>
                        <span (mouseup)="onMessageMouseUp(mensaje, textHost)" #textHost>
                          {{ mensaje.contenido }}
                        </span>
                      </ng-template>
                    </ng-template>
                  </span>

                  <i *ngIf="mensaje.emisorId === usuarioActualId" class="bi bi-check2-all double-check"
                    [ngClass]="mensaje.leido ? 'leido' : 'no-leido'"></i>

                  <div *ngIf="mensaje.emisorId === usuarioActualId && mensaje.activo" class="menu-opciones">
                    <i class="bi bi-three-dots-vertical" role="button" data-bs-toggle="collapse"
                      [attr.data-bs-target]="'#opciones-' + mensaje.id" aria-expanded="false"
                      [attr.aria-controls]="'opciones-' + mensaje.id"></i>
                    <div class="collapse opciones-collapse" [attr.id]="'opciones-' + mensaje.id">
                      <button type="button" class="btn-opcion-eliminar" (click)="eliminarMensaje(mensaje)">
                        <i class="bi bi-trash"></i> Eliminar
                      </button>
                    </div>
                  </div>

                </div>
              </div>
            </ng-container>
          </div>
        </div>

        <div class="ai-panel" *ngIf="aiPanelOpen">
          <div class="ai-panel__header">
            <span>Preguntarle a la IA</span>
            <button type="button" class="ai-close" (click)="cancelAiPanel()" title="Cerrar">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>

        <div *ngIf="chatSeleccionadoId !== null" class="entrada-mensaje">
          <ng-container *ngIf="!recording; else grabandoUI">
            <textarea [(ngModel)]="mensajeNuevo" (keydown)="onKeydown($event)" (keydown.enter)="onEnter($event)"
              [placeholder]="chatEstaBloqueado ? (yoLoBloquee ? 'Has bloqueado a este usuario.' : 'Est√°s bloqueado por este usuario.') : 'Escribe un mensaje...'"
              class="input-mensaje" [disabled]="chatEstaBloqueado" [readonly]="haSalidoDelGrupo"
              [class.input-mensaje--loading]="aiLoading"
              [class.input-mensaje--salido]="haSalidoDelGrupo || chatEstaBloqueado"
              [title]="chatEstaBloqueado ? (yoLoBloquee ? 'Has bloqueado a este usuario' : 'Est√°s bloqueado') : ''">
            </textarea>
            <button class="btn-mic"
              [title]="chatEstaBloqueado ? (yoLoBloquee ? 'Has bloqueado a este usuario' : 'Est√°s bloqueado') : 'Grabar audio'"
              (click)="startRecording()" [disabled]="haSalidoDelGrupo || chatEstaBloqueado"
              [class.btn-disabled-block]="chatEstaBloqueado">
              <i class="fas fa-microphone"></i>
            </button>
            <button class="btn-enviar"
              [title]="chatEstaBloqueado ? (yoLoBloquee ? 'Has bloqueado a este usuario' : 'Est√°s bloqueado') : 'Enviar mensaje'"
              (click)="enviarMensaje()" [disabled]="aiLoading || chatEstaBloqueado || haSalidoDelGrupo"
              [class.btn-disabled-block]="chatEstaBloqueado">
              <i class="fas fa-paper-plane"></i>
            </button>
          </ng-container>

          <ng-template #grabandoUI>
            <div class="rec-wrapper">
              <button class="btn-mic recording" disabled title="Grabando‚Ä¶">
                <span class="rec-dot" aria-hidden="true"></span>
                <i class="fas fa-microphone"></i>
              </button>
              <div class="rec-visual" aria-live="polite">
                <div class="rec-wave" aria-hidden="true">
                  <span class="bar" *ngFor="let _ of recBars; trackBy: trackIndex"></span>
                </div>
                <span class="rec-timer">{{ formatDur(recordElapsedMs) }}</span>
              </div>
              <button class="btn-send-audio" title="Enviar audio" (click)="stopRecordingAndSend()">
                <i class="fas fa-paper-plane"></i>
              </button>
              <button class="btn-cancel-rec" title="Cancelar grabaci√≥n" (click)="cancelRecording()">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>

<app-crear-grupo-modal #crearGrupoModal [currentUserId]="usuarioActualId"
  (create)="onCrearGrupo($event)"></app-crear-grupo-modal>