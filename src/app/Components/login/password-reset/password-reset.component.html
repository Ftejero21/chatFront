<div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content auth-card" (click)="$event.stopPropagation()">

        <div class="modal-header auth-header fancy-header mb-4" style="margin-bottom: 2rem;">
            <div class="auth-brand">
                <span class="brand-mark"><i class="fas fa-lock brand-icon"></i></span>
                <span class="brand-name">TejeChat</span>
            </div>
            <button class="close-btn" (click)="closeModal()"><i class="fas fa-times"></i></button>
        </div>

        <!-- Step 1: Request Email -->
        <div *ngIf="step === 1" class="step-container">
            <h3 class="mb-2" style="color: var(--text-color); font-weight: 600;">Recuperar Contraseña</h3>
            <p class="mb-4 text-muted" style="font-size: 0.9rem; margin-bottom: 1.5rem;">Ingresa tu correo electrónico y
                te enviaremos un código para restablecer tu contraseña.</p>

            <label class="input-group">
                <i class="bi bi-envelope"></i>
                <input type="email" [(ngModel)]="email" placeholder="Tu correo electrónico" required
                    [disabled]="isLoading" />
            </label>

            <div *ngIf="errorMsg" class="alert alert-danger"
                style="font-size: 0.85rem; padding: 10px; border-radius: 8px; margin-top: 10px; background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7;">
                {{ errorMsg }}</div>
            <div *ngIf="successMsg" class="alert alert-success"
                style="font-size: 0.85rem; padding: 10px; border-radius: 8px; margin-top: 10px; background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc;">
                {{ successMsg }}</div>

            <button class="btn-primary w-100 mt-2" style="margin-top: 1.5rem; width: 100%;" (click)="solicitarCodigo()"
                [disabled]="isLoading">
                <span *ngIf="isLoading"><i class="fas fa-spinner fa-spin"></i> Enviando...</span>
                <span *ngIf="!isLoading">Enviar Código</span>
            </button>
        </div>

        <!-- Step 2: Verification and Reset -->
        <div *ngIf="step === 2" class="step-container">
            <h3 class="mb-2" style="color: var(--text-color); font-weight: 600;">Verificar Código</h3>
            <p class="mb-3 text-muted" style="font-size: 0.9rem; margin-bottom: 1.5rem;">Hemos enviado un código al
                correo <strong>{{ email }}</strong></p>

            <label class="input-group mb-3 text-center">
                <i class="bi bi-shield-lock"></i>
                <input type="text" [(ngModel)]="code" placeholder="Código de 6 dígitos" maxlength="6"
                    [disabled]="isLoading || timeLeft === 0" class="code-input"
                    style="letter-spacing: 5px; font-weight: bold; font-size: 1.2rem; text-align: center;" />
            </label>

            <div class="timer-box text-center" style="margin-bottom: 1rem; text-align: center;"
                [class.danger]="timeLeft <= 30">
                <span *ngIf="timeLeft > 0"><i class="far fa-clock"></i> El código caduca en: <strong
                        style="font-size: 1.1rem; letter-spacing: 1px;">{{ formatTime(timeLeft) }}</strong></span>
                <span *ngIf="timeLeft === 0" style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> El
                    código ha caducado.</span>
            </div>

            <label class="input-group">
                <i class="bi bi-key"></i>
                <input [type]="showNewPassword ? 'text' : 'password'" [(ngModel)]="newPassword" placeholder="Nueva contraseña"
                    [disabled]="isLoading || timeLeft === 0" />
                <button
                    type="button"
                    class="password-toggle"
                    [class.is-visible]="showNewPassword"
                    (click)="toggleNewPasswordVisibility()"
                    [attr.aria-label]="showNewPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'"
                    [disabled]="isLoading || timeLeft === 0"
                >
                    <i [class]="showNewPassword ? 'bi bi-eye' : 'bi bi-eye-slash'"></i>
                </button>
            </label>

            <label class="input-group">
                <i class="bi bi-key-fill"></i>
                <input [type]="showRepeatPassword ? 'text' : 'password'" [(ngModel)]="repeatPassword" placeholder="Repite nueva contraseña"
                    [disabled]="isLoading || timeLeft === 0" />
                <button
                    type="button"
                    class="password-toggle"
                    [class.is-visible]="showRepeatPassword"
                    (click)="toggleRepeatPasswordVisibility()"
                    [attr.aria-label]="showRepeatPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'"
                    [disabled]="isLoading || timeLeft === 0"
                >
                    <i [class]="showRepeatPassword ? 'bi bi-eye' : 'bi bi-eye-slash'"></i>
                </button>
            </label>

            <div *ngIf="errorMsg" class="alert alert-danger"
                style="font-size: 0.85rem; padding: 10px; border-radius: 8px; margin-top: 10px; background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7;">
                {{ errorMsg }}</div>
            <div *ngIf="successMsg" class="alert alert-success"
                style="font-size: 0.85rem; padding: 10px; border-radius: 8px; margin-top: 10px; background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc;">
                {{ successMsg }}</div>

            <button *ngIf="timeLeft > 0" class="btn-primary w-100 mt-2" style="margin-top: 1.5rem; width: 100%;"
                (click)="verificarYGuardar()" [disabled]="isLoading || !code || !newPassword || !repeatPassword">
                <span *ngIf="isLoading"><i class="fas fa-spinner fa-spin"></i> Verificando...</span>
                <span *ngIf="!isLoading">Actualizar Contraseña</span>
            </button>

            <button *ngIf="timeLeft === 0" class="btn-outline w-100 mt-2" style="margin-top: 1.5rem; width: 100%;"
                (click)="resendCode()" [disabled]="isLoading">
                <span *ngIf="isLoading"><i class="fas fa-spinner fa-spin"></i> Solicitando...</span>
                <span *ngIf="!isLoading"><i class="fas fa-redo"></i> Solicitar Nuevo Código</span>
            </button>
        </div>

    </div>
</div>
